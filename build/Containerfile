# NPM & MVN steps were already executed by pipeline
# async-api is now under dist/
# openapi is now under dist/

# ----------------------------------------------------------------------------------------------------------------------
FROM zar.entw.bund.drv/bund-rvevo-docker/drv/devimage-udi8:1b04aad2f69@sha256:e1137f69aae0f40fe721455506740dd59effb514fb28430678c98f806aec4506 AS index-builder

#COPY *-async-api/src/main/resources/*-asyncapi.yaml /work/asyncapi/
COPY *-rest-api/src/main/resources/*-api.yaml /work/openapi/
COPY src/main/resources/index/* /work/index/
COPY build/index-builder.sh /work
RUN bash /work/index-builder.sh

# ----------------------------------------------------------------------------------------------------------------------
FROM zar.entw.bund.drv/bund-rvevo-docker/swaggerapi/swagger-ui:v4.18.2@sha256:05cc73230400c042b34d10b81c56ea9f4f75f49348afe678abc560d3db1afeea AS swagger-ui

# Patch swagger-initializer.js
RUN sed -i -e "s/url: .*/url: new URL(document.location).searchParams.get(\"api\"),/" /usr/share/nginx/html/swagger-initializer.js

# ----------------------------------------------------------------------------------------------------------------------
FROM zar.entw.bund.drv/bund-rvevo-docker/drv/baseimage-nginx-120:9f70fc2c8c5@sha256:cee5c5ea79498123ab76bb7287a06862a3c80f5881cd71f3f666a1ae25ece733

COPY dist/ /opt/app-root/src/asyncapi/
COPY *-rest-api/*-spec/target/*-openapi.yaml /opt/app-root/src/openapi/
COPY --from=index-builder /app/index.html /opt/app-root/src/
COPY --from=swagger-ui /usr/share/nginx/html/* /opt/app-root/src/swagger-ui/
